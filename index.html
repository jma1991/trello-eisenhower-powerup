<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
</head>
<body>
  <h1>Eisenhower Matrix Power-Up</h1>
  <p>This is the connector page for the Power-Up.</p>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    var POPUP_URL = './popup.html';
    var ICON_URL = './icon.svg';

    // Quadrant definitions
    var QUADRANTS = {
      doIt: { name: 'Do It', color: 'green' },
      scheduleIt: { name: 'Schedule It', color: 'blue' },
      delegateIt: { name: 'Delegate It', color: 'yellow' },
      dontDoIt: { name: "Don't Do It", color: 'red' }
    };

    function getQuadrant(importance, urgency) {
      if (importance === 'yes' && urgency === 'yes') return QUADRANTS.doIt;
      if (importance === 'yes' && urgency === 'no') return QUADRANTS.scheduleIt;
      if (importance === 'no' && urgency === 'yes') return QUADRANTS.delegateIt;
      if (importance === 'no' && urgency === 'no') return QUADRANTS.dontDoIt;
      return null;
    }

    TrelloPowerUp.initialize({
      'card-buttons': function(t, options) {
        return [{
          icon: ICON_URL,
          text: 'Eisenhower Matrix',
          callback: function(t) {
            return t.popup({
              title: 'Eisenhower Matrix',
              url: POPUP_URL,
              height: 184
            });
          }
        }];
      },
      'card-badges': function(t, options) {
        return t.get('card', 'shared', 'eisenhowerMatrix')
          .then(function(data) {
            if (!data || !data.importance || !data.urgency) {
              return [];
            }
            var quadrant = getQuadrant(data.importance, data.urgency);
            if (!quadrant) return [];
            return [{
              text: quadrant.name,
              color: quadrant.color
            }];
          });
      },
      'card-detail-badges': function(t, options) {
        return t.get('card', 'shared', 'eisenhowerMatrix')
          .then(function(data) {
            if (!data || !data.importance || !data.urgency) {
              return [];
            }
            var quadrant = getQuadrant(data.importance, data.urgency);
            return [
              {
                title: 'Important',
                text: data.importance === 'yes' ? 'Yes' : 'No',
                callback: function(t) {
                  return t.popup({
                    title: 'Eisenhower Matrix',
                    url: POPUP_URL,
                    height: 184
                  });
                }
              },
              {
                title: 'Urgent',
                text: data.urgency === 'yes' ? 'Yes' : 'No',
                callback: function(t) {
                  return t.popup({
                    title: 'Eisenhower Matrix',
                    url: POPUP_URL,
                    height: 184
                  });
                }
              },
              {
                title: 'Quadrant',
                text: quadrant ? quadrant.name : '-',
                color: quadrant ? quadrant.color : null
              }
            ];
          });
      },
      'list-sorters': function(t) {
        return [{
          text: 'Eisenhower Quadrant',
          callback: function(t, opts) {
            var cards = opts.cards;
            return Promise.all(cards.map(function(card) {
              return t.get(card.id, 'shared', 'eisenhowerMatrix')
                .then(function(data) {
                  return { id: card.id, data: data };
                });
            })).then(function(results) {
              var WEIGHTS = {
                'yes-yes': 1,  // Do It
                'yes-no': 2,   // Schedule It
                'no-yes': 3,   // Delegate It
                'no-no': 4     // Don't Do It
              };
              function getWeight(data) {
                if (!data || !data.importance || !data.urgency) return 5;
                var key = data.importance + '-' + data.urgency;
                return WEIGHTS[key] || 5;
              }
              results.sort(function(a, b) {
                return getWeight(a.data) - getWeight(b.data);
              });
              return {
                sortedIds: results.map(function(r) { return r.id; })
              };
            });
          }
        }];
      }
    });
  </script>
</body>
</html>
